// src/components/formularios/Paso1.jsx

import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Card } from '@/components/ui/card';
import { useCaratula } from '@/context/CaratulaContext';
import { cn } from '@/lib/utils'; // ‚Üê IMPORT NECESARIO PARA ‚Äúcn‚Äù

// Opciones disponibles para hogares y meses
const hogaresDisponibles = ['San Mart√≠n', 'Rawson'];
const mesesDisponibles = [
  'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
  'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
];

// Funci√≥n que asegura que todos los campos del formulario est√©n definidos
const normalizarForm = (f) => ({
  expediente: f?.expediente || '',
  remito: f?.remito || '',
  monto: f?.monto || '',
  servicio: f?.servicio || '',
  mes: f?.mes || 'abril2025',
  hogar: f?.hogar || 'San Mart√≠n',
});

export default function Paso1() {
  const navigate = useNavigate();
  const { caratula, seleccionarCaratula, limpiarCaratula } = useCaratula();

  // Si ya hay una car√°tula activa en el contexto, la usamos para inicializar el form.
  const [form, setForm] = useState(() => normalizarForm(caratula));
  const [texto, setTexto] = useState('');
  const [cabecerasGuardadas, setCabecerasGuardadas] = useState([]);

  // Genera la clave de localStorage para esta car√°tula
  const claveActual = `cabecera_${form.hogar}_${form.mes}`;

  // Al montar (o cambiar ‚ÄúclaveActual‚Äù), intento cargar datos previos
  useEffect(() => {
    const saved = localStorage.getItem(claveActual);
    if (saved) {
      const parsed = JSON.parse(saved);
      const limpio = normalizarForm(parsed);
      setForm(limpio);
      setTexto(generarTexto(limpio));
    }
  }, [claveActual]);

  // Cada vez que cambie ‚Äútexto‚Äù recargo la lista de car√°tulas guardadas
  useEffect(() => {
    cargarCaratulasValidas();
  }, [texto]);

  // Funci√≥n para leer todas las car√°tulas existentes en localStorage
  const cargarCaratulasValidas = () => {
    const claves = Object.keys(localStorage).filter((k) => k.startsWith('cabecera_'));
    const cargadas = claves
      .map((k) => {
        try {
          const data = JSON.parse(localStorage.getItem(k));
          return data?.mes && data?.hogar ? { ...data, key: k } : null;
        } catch {
          return null;
        }
      })
      .filter(Boolean);
    setCabecerasGuardadas(cargadas);
  };

  // Manejo de cambios en inputs/selects
  const handleChange = (e) => {
    const { name, value } = e.target;
    setForm((prev) => normalizarForm({ ...prev, [name]: value }));
  };

  // Construye el texto de resumen de car√°tula
  const generarTexto = (datos = form) => `
PERIODO DE TRABAJO: ${(datos.mes || '‚Äî').toUpperCase()} ‚Äì HOGAR: ${datos.hogar || '‚Äî'}

C√≥digo de expediente: ${datos.expediente || '‚Äî'}
N√∫mero de remito: ${datos.remito || '‚Äî'}
Monto total del servicio: $${datos.monto || '‚Äî'}
Servicio solicitado: ${datos.servicio || '‚Äî'}
  `.trim();

  // Guardar la car√°tula actual en localStorage y en el contexto
  const guardar = () => {
    if (!form.expediente || !form.remito || !form.monto || !form.servicio) {
      alert('Todos los campos deben estar completos');
      return;
    }
    const limpio = normalizarForm(form);
    localStorage.setItem(`cabecera_${limpio.hogar}_${limpio.mes}`, JSON.stringify(limpio));
    seleccionarCaratula(limpio);
    localStorage.setItem('caratula_activa', JSON.stringify(limpio));
    setTexto(generarTexto(limpio));
    cargarCaratulasValidas();
  };

  // Borrar la car√°tula activa
  const borrar = () => {
    localStorage.removeItem(claveActual);
    limpiarCaratula();
    localStorage.removeItem('caratula_activa');
    const limpio = normalizarForm(null);
    setForm(limpio);
    setTexto('');
    cargarCaratulasValidas();
    // Luego de borrar, navegamos al mismo Paso 1 con valores por defecto
    navigate(`/paso/1?mes=${limpio.mes}&hogar=${encodeURIComponent(limpio.hogar)}`);
  };

  // Cuando el usuario selecciona una de las car√°tulas guardadas
  const seleccionarCabecera = (cab) => {
    const limpio = normalizarForm(cab);
    setForm(limpio);
    setTexto(generarTexto(limpio));
    seleccionarCaratula(limpio);
    localStorage.setItem('caratula_activa', JSON.stringify(limpio));
  };

  // Permite limpiar cualquier entrada inv√°lida en localStorage
  const limpiarCaratulasInvalidas = () => {
    const claves = Object.keys(localStorage).filter((k) => k.startsWith('cabecera_'));
    let eliminadas = 0;

    claves.forEach((k) => {
      try {
        const data = JSON.parse(localStorage.getItem(k));
        if (!data?.mes || !data?.hogar) {
          localStorage.removeItem(k);
          eliminadas++;
        }
      } catch {
        localStorage.removeItem(k);
        eliminadas++;
      }
    });

    if (eliminadas > 0) {
      alert(`${eliminadas} car√°tulas inv√°lidas fueron eliminadas.`);
      cargarCaratulasValidas();
    } else {
      alert('No se encontraron car√°tulas inv√°lidas.');
    }
  };

  return (
    <div className="space-y-6 max-w-4xl mx-auto">
      {/* Banner que muestra la car√°tula activa */}
      <div className="bg-blue-100 text-blue-800 px-4 py-2 rounded shadow text-sm">
        <strong>Car√°tula activa:</strong> {form.hogar} ‚Äì {form.mes?.toUpperCase() || '‚Äî'} ‚Äì Expediente:{' '}
        {form.expediente || '‚Äî'}
      </div>

      {/* Formulario de edici√≥n/creaci√≥n de car√°tula */}
      <form
        className="space-y-4"
        onSubmit={(e) => {
          e.preventDefault();
          guardar();
        }}
      >
        <Input
          name="expediente"
          value={form.expediente}
          onChange={handleChange}
          placeholder="C√≥digo de expediente"
        />
        <Input
          name="remito"
          value={form.remito}
          onChange={handleChange}
          placeholder="N√∫mero de remito"
        />
        <Input
          name="monto"
          value={form.monto}
          onChange={handleChange}
          placeholder="Monto total ($)"
        />
        <Input
          name="servicio"
          value={form.servicio}
          onChange={handleChange}
          placeholder="Tipo de servicio (ej: lavander√≠a)"
        />

        <div className="grid grid-cols-2 gap-4">
          <select
            name="mes"
            value={form.mes}
            onChange={handleChange}
            className="border rounded p-2"
          >
            {mesesDisponibles.map((m) => (
              <option key={m} value={`${m}2025`}>
                {m.toUpperCase()} 2025
              </option>
            ))}
          </select>
          <select
            name="hogar"
            value={form.hogar}
            onChange={handleChange}
            className="border rounded p-2"
          >
            {hogaresDisponibles.map((h) => (
              <option key={h} value={h}>
                {h}
              </option>
            ))}
          </select>
        </div>

        <div className="flex gap-2">
          <Button type="submit">Guardar car√°tula</Button>
          <Button type="button" variant="destructive" onClick={borrar}>
            Borrar
          </Button>
          <Button type="button" variant="outline" onClick={() => navigate('/dashboard')}>
            Volver al men√∫ principal
          </Button>
          <Button type="button" variant="ghost" onClick={limpiarCaratulasInvalidas}>
            üßπ Limpiar inv√°lidas
          </Button>
        </div>

        {texto && <Textarea className="mt-4" value={texto} rows={8} readOnly />}
      </form>

      {/* Lista de car√°tulas guardadas */}
      <hr className="my-6" />
      <h3 className="text-lg font-semibold">üìÇ Car√°tulas guardadas</h3>

      {cabecerasGuardadas.length === 0 ? (
        <p className="text-gray-500 italic">No hay car√°tulas guardadas a√∫n.</p>
      ) : (
        <div className="grid gap-4">
          {cabecerasGuardadas.map((cab, i) => {
            if (!cab?.mes || !cab?.hogar) return null;
            const isActiva = cab.mes === form.mes && cab.hogar === form.hogar;
            const clave = `cabecera_${cab.hogar}_${cab.mes}`;

            return (
              <Card
                key={i}
                className={cn(
                  'p-4 flex justify-between items-center border',
                  isActiva ? 'border-blue-600 bg-blue-50' : 'border-gray-200'
                )}
              >
                <div className="space-y-1">
                  <div className="font-semibold">
                    {cab.hogar} ‚Äì {cab.mes.toUpperCase()}
                    {isActiva && <span className="ml-2 text-xs text-blue-700">(activa)</span>}
                  </div>
                  <div className="text-sm text-gray-600">Expediente: {cab.expediente || '‚Äî'}</div>
                </div>
                <div className="flex gap-2">
                  {!isActiva && (
                    <Button size="sm" onClick={() => seleccionarCabecera(cab)}>
                      üü¢ Usar
                    </Button>
                  )}
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => {
                      const limpio = normalizarForm(cab);
                      setForm(limpio);
                      setTexto(generarTexto(cab));
                    }}
                  >
                    ‚úèÔ∏è Ver/editar
                  </Button>
                  <Button
                    size="sm"
                    variant="destructive"
                    onClick={() => {
                      if (confirm(`¬øEliminar la car√°tula ${cab.hogar} ‚Äì ${cab.mes}?`)) {
                        localStorage.removeItem(clave);
                        cargarCaratulasValidas();
                      }
                    }}
                  >
                    üóë Eliminar
                  </Button>
                </div>
              </Card>
            );
          })}
        </div>
      )}
    </div>
  );
}
